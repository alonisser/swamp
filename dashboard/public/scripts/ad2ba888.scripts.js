"use strict";var app=angular.module("swamp",["swamp.config","ngCookies","ngResource","ngSanitize","ui.router","Scope.safeApply","Scope.onReady","swamp.filters","swamp.controllers","swamp.directives","swamp.services"]);angular.module("swamp.config",[]),angular.module("swamp.filters",[]),angular.module("swamp.controllers",[]),angular.module("swamp.directives",[]),angular.module("swamp.services",[]),app.run(["socketService","swampManager",function(a,b){b.initialize(),a.setup()}]),angular.module("swamp.config").constant("env",{name:"production",serviceUptimeTickInterval:5e3}),app.config(["env",function(a){"production"==a.name&&(a.socketConnectionString=socketConnectionString)}]),app.config(["$locationProvider","$urlRouterProvider",function(a,b){a.html5Mode(!0),b.otherwise("/404/")}]),angular.module("swamp.config").constant("SOCKET_EVENTS",{CONNECT:"connect",DISCONNECT:"disconnect",MESSAGE:"message",SWAMP_INITIAL:"swamp.initialData",SWAMP_OUT:"swamp.out",SWAMP_ERROR:"swamp.error",SWAMP_RESTART_ALL:"swamp.restartAllRunning",SWAMP_STOP_ALL:"swamp.stopAllRunning",SWAMP_START_ALL:"swamp.startAll",SERVICE_START:"service.start",SERVICE_STOP:"service.stop",SERVICE_RESTART:"service.restart",SERVICE_ERROR:"service.error",SERVICE_OUT:"service.out",SERVICE_MONITOR:"service.monitor"}).constant("EVENTS",{SWAMP_SERVICES_RECEIVED:"event::swamp.services.received",SWAMP_DISCONNECTED:"event::swamp.disconnected",SWAMP_OUT:"event::swamp.out",SWAMP_ERROR:"event::swamp.error",SWAMP_DATA_RECEIVED:"event::swamp.data.received",SERVICE_MONITOR_UPDATE:"event::service.monitor.update",SERVICE_START:"event::service.start",SERVICE_STOP:"event::service.stop",SERVICE_RESTART:"event::service.restart",SERVICE_OUT:"event::service.out",SERVICE_ERROR:"event::service.error"}).constant("SERVICE_STATE",{STOP:"service.state.stop",RUN:"service.state.run",RESTART:"service.state.restart"}).constant("CLIENT_REQUEST",{REQUEST_START_SERVICE:"request.start.service",REQUEST_STOP_SERVICE:"request.stop.service",REQUEST_RESTART_SERVICE:"request.restart.service"}).constant("AGGREGATED_LIST_TYPE",{LIFO:1,FIFO:2}).constant("LOG_TYPE",{OUT:"log.out",ERROR:"log.error"}),_.mixin({deepFind:function(a,b,c){var d,e,f,g=0;for(d=b&&b.split("."),e=d&&d.length;e>g&&a;){if(f=d[g],g++,g>=e&&null!=c)return void(a[f]=c);a=a[f]}return e>g&&(a=null),a}}),_.mixin({pushAll:function(a,b){a.push.apply(a,b)}}),_.mixin({emptyArray:function(a){a.length=0}}),_.mixin({nextPrevPageParser:function(a){var b={},c=a._resultmeta||a;return c.next&&(b.next=_.parseInt(/\w*page=(\d+)/i.exec(c.next)[1])),c.previous&&(b.prev=_.parseInt(/\w*page=(\d+)/i.exec(c.previous)[1])),b}}),_.mixin({cloneArray:function(a){return a.slice(0)}}),_.mixin({throttleStore:function(a,b,c){var d=[],e=_.throttle(function(){a(_.cloneArray(d)),_.emptyArray(d)},b,c);return function(a){_.pushAll(d,a),e()}}}),_.mixin({arrayRemoveItem:function(a,b){var c=a.indexOf(b);-1!=c&&a.splice(c,1)}}),_.mixin({toFixed:function(a,b){return parseFloat(a.toPrecision(b||12))}}),_.mixin({getUrls:function(a){for(var b,c,d=/((ftp|https?):\/\/|(mailto:)?[A-Za-z0-9._%+-]+@)\S*[^\s.;,(){}<>]/,e=[];c=a.match(d);)b=c[0],e.push(b),a=a.replace(b,"");return e}}),_.mixin({guid:function(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).substr(-4)}}),_.mixin({bytesToSize:function(a){var b=1e3,c=["Bytes","KB","MB","GB","TB"];if(0===a)return"0 Bytes";var d=parseInt(Math.floor(Math.log(a)/Math.log(b)),10);return(a/Math.pow(b,d)).toPrecision(3)+" "+c[d]}}),angular.module("swamp.services").factory("swampServicesFactory",["$rootScope","env","SERVICE_STATE","CLIENT_REQUEST","aggregatedDataFactory","AGGREGATED_LIST_TYPE","LOG_TYPE","serializeService",function(a,b,c,d,e,f,g,h){function i(a){this.id=a.id,this.name=a.name,this.description=a.description,this.path=a.path,this.script=a.script,this.isRunning=a.isRunning,this.runningEnvironment=a.runningEnvironment,this.pid=a.pid,this.options=a.options,this.environments=a.environments,this.monitorCpu=a.monitor.cpu,this.monitorMemory=a.monitor.memory,this.monitor=a.monitor,this.state=this.isRunning?c.RUN:c.STOP,this.startTime=a.startTime,this.uptime=null,this._uptimeInterval=null,this._createMonitorDataContainers(),this._createLogDataContainers(this.options.maxLogsToSave),this.isRunning&&this._startUptimeMessageSync(),k.call(this,a.logs)}function j(a){return new i(a)}function k(a){var b,c=this;a.err&&_.forEach(a.err,function(a){b=h.serializeLogData(g.ERROR,a),c.errorLogData.add(b)}),a.out&&_.forEach(a.out,function(a){b=h.serializeLogData(g.OUT,a),c.outLogData.add(b)})}return i.prototype={updateMonitorData:function(b){this.monitor=b,this.cpuData.add(this.monitor.cpu),this.memoryData.add(this.monitor.memory),a.$safeApply()},stop:function(){a.$broadcast(d.REQUEST_STOP_SERVICE,this)},start:function(b){a.$broadcast(d.REQUEST_START_SERVICE,this,b)},restart:function(b){a.$broadcast(d.REQUEST_RESTART_SERVICE,this,b)},forceStop:function(){this._stopUptimeMessageSync(),this.pid=null,this.isRunning=!1,this.startTime=null,this.cpuData.clear(),this.memoryData.clear(),this.monitor.cpu=0,this.monitor.memory=0,this.state=c.STOP,a.$safeApply()},forceStart:function(b){this._startUptimeMessageSync(),this._merge(b),this.state=c.RUN,a.$safeApply()},forceRestart:function(){this.state=c.RESTART,a.$safeApply()},log:function(a,b){var c=h.serializeLogData(a,b);switch(a){case g.OUT:this.outLogData.add(c);break;case g.ERROR:this.errorLogData.add(c)}},clearErrorLogs:function(){this.errorLogData.clear()},clearOutLogs:function(){this.outLogData.clear()},clearLogs:function(){this.clearErrorLogs(),this.clearOutLogs()},dispose:function(){this.forceStop()},_merge:function(a){_.assign(this,a)},_createMonitorDataContainers:function(){this.cpuData=e.create(f.FIFO,100),this.memoryData=e.create(f.FIFO,100)},_createLogDataContainers:function(a){this.outLogData=e.create(f.FIFO,a),this.errorLogData=e.create(f.FIFO,a)},_startUptimeMessageSync:function(){this.uptime=moment(new Date).from(this.startTime),this._uptimeInterval=setTimeout(function(){this._startUptimeMessageSync()}.bind(this),b.serviceUptimeTickInterval)},_stopUptimeMessageSync:function(){clearTimeout(this._uptimeInterval),this._uptimeInterval=null,this.uptime=null}},{create:j}}]),angular.module("swamp.services").factory("aggregatedDataFactory",["AGGREGATED_LIST_TYPE","$rootScope",function(a,b){function c(b,c){this.type=b||a.FIFO,this.maxItems=c||0,this._data=[]}function d(a,b){return new c(a,b)}return c.prototype={add:function(a){return this._data.push(a),this.maxItems>0&&this.count()>this.maxItems?this._automatedRemove():void b.$safeApply()},remove:function(a){this._data.splice(a,1),b.$safeApply()},get:function(a){return this._data[a]},getAll:function(){return this._data},clear:function(){this._data.length=0,b.$safeApply()},count:function(){return this._data.length},_automatedRemove:function(){switch(this.type){case a.FIFO:this.remove(this.count()-1);break;case a.LIFO:this.remove(0)}}},{create:d}}]),angular.module("swamp.services").service("serializeService",[function(){this.serializeSwampService=function(a){return{id:_.guid(),name:a.name,description:a.description,path:a.path,script:a.script,isRunning:a.isRunning,runningEnvironment:a.runningEnvironment,pid:a.pid,startTime:a.startTime,options:a.options,environments:a.environments,monitorCpu:a.monitor.cpu,monitorMemory:a.monitor.memory,logs:a.logs,monitor:{cpu:0,memory:0}}},this.serializeMonitorData=function(a){return{cpu:a.monitor.cpu,memory:a.monitor.memory}},this.serializeServiceStart=function(a){return{isRunning:a.isRunning,runningEnvironment:a.runningEnvironment,pid:a.pid,startTime:a.startTime}},this.serializeServiceStop=function(a){return{pid:a.pid,startTime:a.startTime}},this.serializeLogData=function(a,b){return{type:a,text:b.text,time:moment(b.time)}}}]),angular.module("swamp.services").service("socketService",["SOCKET_EVENTS","EVENTS","swampServicesManager","serializeService","env","$rootScope",function(a,b,c,d,e,f){this._socket=null,this.setup=function(){this._socket=io.connect(e.socketConnectionString,{reconnect:!1}),this._bindSocketEvents()},this._bindSocketEvents=function(){this._socket.on(a.CONNECT,this._onSocketConnect.bind(this)),this._socket.on(a.DISCONNECT,this._onSocketDisconnect.bind(this)),this._socket.on(a.MESSAGE,this._onSocketMessage.bind(this))},this._emit=function(a,b){b=b||{},a=a.name||a,this._socket.emit(a,b)},this._onSocketConnect=function(){},this._onSocketDisconnect=function(){f.$broadcast(b.SWAMP_DISCONNECTED)},this._onSocketMessage=function(c){if(c&&c.event)switch(c.event){case a.SWAMP_INITIAL:var e=[];_.forEach(c.data.services||[],function(a){e.push(d.serializeSwampService(a))}),f.$broadcast(b.SWAMP_SERVICES_RECEIVED,e),f.$broadcast(b.SWAMP_DATA_RECEIVED,c.data.swamp);break;case a.SWAMP_OUT:var g=c.data.log;f.$broadcast(b.SWAMP_OUT,g);break;case a.SWAMP_ERROR:var g=c.data.log;f.$broadcast(b.SWAMP_ERROR,g);break;case a.SERVICE_MONITOR:var e=d.serializeMonitorData(c.data),h=c.data.name;f.$broadcast(b.SERVICE_MONITOR_UPDATE,h,e);break;case a.SERVICE_START:var e=d.serializeServiceStart(c.data),h=c.data.name;f.$broadcast(b.SERVICE_START,h,e);break;case a.SERVICE_STOP:var e=d.serializeServiceStop(c.data),h=c.data.name;f.$broadcast(b.SERVICE_STOP,h,e);break;case a.SERVICE_RESTART:var h=c.data.name;f.$broadcast(b.SERVICE_RESTART,h);break;case a.SERVICE_OUT:var h=c.data.name,g=c.data.log;f.$broadcast(b.SERVICE_OUT,h,g);break;case a.SERVICE_ERROR:var h=c.data.name,g=c.data.log;f.$broadcast(b.SERVICE_ERROR,h,g)}},f.$on(a.SERVICE_START,this._emit.bind(this)),f.$on(a.SERVICE_STOP,this._emit.bind(this)),f.$on(a.SERVICE_RESTART,this._emit.bind(this)),f.$on(a.SWAMP_STOP_ALL,this._emit.bind(this)),f.$on(a.SWAMP_RESTART_ALL,this._emit.bind(this))}]),angular.module("swamp.services").service("swampManager",["$rootScope","EVENTS","LOG_TYPE","serializeService","aggregatedDataFactory","AGGREGATED_LIST_TYPE",function(a,b,c,d,e,f){function g(a,b){this.log(c.OUT,b)}function h(a,b){this.log(c.ERROR,b)}function i(a,b){var d=this;b.logs&&(_.forEach(b.logs.out||[],function(a){d.log(c.OUT,a)}),_.forEach(b.logs.err||[],function(a){d.log(c.ERROR,a)}))}this.outLogData=null,this.errorLogData=null,this.log=function(a,b){var e=d.serializeLogData(a,b);switch(a){case c.OUT:this.outLogData.add(e);break;case c.ERROR:this.errorLogData.add(e)}},this._createLogDataContainers=function(){this.outLogData=e.create(f.FIFO),this.errorLogData=e.create(f.FIFO)},this.initialize=function(){this._createLogDataContainers()},a.$on(b.SWAMP_OUT,g.bind(this)),a.$on(b.SWAMP_ERROR,h.bind(this)),a.$on(b.SWAMP_DATA_RECEIVED,i.bind(this))}]),angular.module("swamp.services").service("swampServicesManager",["swampServicesFactory","$rootScope","EVENTS","CLIENT_REQUEST","SOCKET_EVENTS","LOG_TYPE","SERVICE_STATE",function(a,b,c,d,e,f){function g(){_.forEach(this._services,function(a){a.dispose(),this.removeById(a.id)}.bind(this))}function h(a,b){_.forEach(b,function(a){this.addServiceByRaw(a)}.bind(this))}function i(a,b,c){var d=this.getByName(b);d&&d.updateMonitorData(c)}function j(a,b,c){var d=this.getByName(b);d&&d.forceStart(c)}function k(a,b,c){var d=this.getByName(b);d&&d.forceStop(c)}function l(a,b){var c=this.getByName(b);c&&c.forceRestart()}function m(a,b,c){var d=this.getByName(b);d&&d.log(f.OUT,c)}function n(a,b,c){var d=this.getByName(b);d&&d.log(f.ERROR,c)}function o(a,c,d){var f={name:c.name,environment:d};b.$broadcast(e.SERVICE_START,f)}function p(a,c){var d={name:c.name};b.$broadcast(e.SERVICE_STOP,d)}function q(a,c,d){var f={name:c.name,environment:d};b.$broadcast(e.SERVICE_RESTART,f)}function r(){g.call(this)}this._services={},this.addService=function(a){this._services[a.id]=a},this.addServiceByRaw=function(c){this.addService(a.create(c)),b.$safeApply()},this.getAll=function(){return this._services},this.getByName=function(a){for(var b in this._services)if(this._services[b].name==a)return this.getById(b);return null},this.getById=function(a){return this._services[a]||null},this.removeById=function(a){delete this._services[a],b.$safeApply()},this.stopAllRunningServices=function(){b.$broadcast(e.SWAMP_STOP_ALL)},this.restartAllRunningServices=function(){b.$broadcast(e.SWAMP_RESTART_ALL)},this.startAllServices=function(){},b.$on(c.SWAMP_SERVICES_RECEIVED,h.bind(this)),b.$on(c.SWAMP_DISCONNECTED,r.bind(this)),b.$on(c.SERVICE_MONITOR_UPDATE,i.bind(this)),b.$on(c.SERVICE_START,j.bind(this)),b.$on(c.SERVICE_STOP,k.bind(this)),b.$on(c.SERVICE_RESTART,l.bind(this)),b.$on(c.SERVICE_OUT,m.bind(this)),b.$on(c.SERVICE_ERROR,n.bind(this)),b.$on(d.REQUEST_START_SERVICE,o.bind(this)),b.$on(d.REQUEST_STOP_SERVICE,p.bind(this)),b.$on(d.REQUEST_RESTART_SERVICE,q.bind(this))}]),angular.module("swamp.controllers").controller("headerController",["$scope","swampServicesManager",function(a,b){a.restartAll=function(){b.restartAllRunningServices()},a.stopAll=function(){b.stopAllRunningServices()},a.startAll=function(){b.startAllServices()}}]),angular.module("swamp.controllers").controller("footerController",["$scope",function(){}]),angular.module("swamp.controllers").controller("mainController",["$scope",function(){}]),app.config(["$stateProvider",function(a){a.state("root",{url:"/",templateUrl:"pages/root/rootView.html",controller:"rootController"})}]),angular.module("swamp.controllers").controller("rootController",["$scope","swampServicesManager","swampManager","SERVICE_STATE",function(a,b,c,d){a.SERVICE_STATE=d,a.services=b.getAll(),a.serviceActions={start:function(a,b){a.start(b)},stop:function(a){a.stop()},restart:function(a,b){a.restart(b)}},a.bytesToSize=_.bytesToSize,a.errorLogs=c.errorLogData.getAll(),a.outLogs=c.outLogData.getAll()}]);